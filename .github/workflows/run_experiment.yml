name: Running experiment

on:
 
  pull_request:
    types: [ labeled ]

jobs:
  
  build:
    if: contains(github.event.pull_request.labels.*.name, 'need_experiment') || github.ref == 'refs/heads/main'
    name: Run experiment
    runs-on: ubuntu-latest

   
    steps:

    - name: Check out code
      uses: actions/checkout@v2
      
    - name: Get the branch name
      id: get-branch-name
      run: echo "::set-output name=BRANCH_NAME::$(echo ${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}})"
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'
        cache: 'pip'
    - run: pip3 install sagemaker argparse PyGithub

    - name: Run the experiment
      id: run-experiment
      env:
        GITHUB_OWNER: ${{ github.repository_owner }}
        GITHUB_REPO: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        EXPERIMENT_NAME: ${{ steps.get-branch-name.outputs.BRANCH_NAME }}-${{ github.sha }}
        S3_OUTPUT_PATH: s3://kuangyuan-logs/${{ steps.get-branch-name.outputs.BRANCH_NAME }}-${{ github.sha }}
        GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
      run: |
        python3 ci/run_experiment.py \
          --experiment-name $EXPERIMENT_NAME \
          --s3-output-path $S3_OUTPUT_PATH
        